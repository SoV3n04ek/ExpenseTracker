<div class="centered-container">
    <div class="card">
        <div class="text-center">
            <h2 class="mt-6">Reset Password</h2>
            <p class="mt-2 text-muted">Please enter your new password below</p>
        </div>

        @if (successMessage()) {
        <div class="success-alert">
            <p><strong>Success!</strong></p>
            <p>{{ successMessage() }}</p>
            <p class="text-xs mt-1">Redirecting in {{ redirectCountdown() }}s...</p>
        </div>
        }

        @if (store.status() === 'error' && store.error()) {
        <div class="error-alert">
            @if (Array.isArray(store.error())) {
            <ul class="mb-0">
                @for (err of asArray(store.error()); track $index) {
                <li>{{ err }}</li>
                }
            </ul>
            } @else {
            <p>{{ store.error() }}</p>
            }
        </div>
        }

        <form [formGroup]="resetForm" (ngSubmit)="onSubmit()" class="mt-8">
            <!-- Hidden Fields -->
            <input type="hidden" formControlName="email">
            <input type="hidden" formControlName="token">

            <div class="space-y-4">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>New Password</mat-label>
                    <input matInput formControlName="newPassword" type="password"
                        placeholder="At least 8 chars, 1 number, 1 special">
                    @if (control.newPassword.errors?.['required']) {
                    <mat-error>Password is required</mat-error>
                    } @else if (control.newPassword.errors?.['minlength']) {
                    <mat-error>Min 8 characters required</mat-error>
                    } @else if (control.newPassword.errors?.['pattern']) {
                    <mat-error>Must include a number and special character</mat-error>
                    }
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Confirm Password</mat-label>
                    <input matInput formControlName="confirmPassword" type="password">
                    @if (control.confirmPassword.errors?.['required']) {
                    <mat-error>Confirmation is required</mat-error>
                    }
                </mat-form-field>

                @if (resetForm.errors?.['passwordMismatch'] && control.confirmPassword.touched) {
                <div class="text-red-500 text-sm mt-[-8px] mb-4 pl-1">
                    Passwords do not match
                </div>
                }
            </div>

            <button mat-flat-button color="primary" type="submit" class="btn-primary mt-6"
                [disabled]="resetForm.invalid || store.isLoading() || successMessage()">

                @if (store.isLoading()) {
                <span class="loading-container">
                    <span class="spinner-sm mr-2"></span>
                    Resetting...
                </span>
                } @else {
                Reset Password
                }
            </button>

            <div class="text-center mt-6">
                <a routerLink="/login" class="success-link">Back to login</a>
            </div>
        </form>
    </div>
</div>